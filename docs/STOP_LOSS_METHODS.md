# 損失確定（Stop Loss）方法の提案

Bitcoin取引エージェントに損失確定機能を追加する際の推奨方法をまとめます。

## 📊 推奨損失確定方法

### 1. **パーセンテージベース損失確定（Percentage-based Stop Loss）** ⭐ 推奨
- **方法**: エントリー価格からの固定パーセンテージ損失で決済
- **設定例**: -5%, -7%, -10%
- **メリット**:
  - シンプルで実装が容易
  - 感情的な判断を排除
  - リスク管理が明確
- **デメリット**:
  - ボラティリティを考慮しない
  - 高ボラティリティ時に頻繁に発動する可能性
- **適用場面**: 基本的な損失確定として最適

### 2. **ATRベース損失確定（ATR-based Stop Loss）** ⭐⭐ 強く推奨
- **方法**: Average True Range (ATR) を使用してボラティリティに応じた損失確定
- **計算式**: `Stop Loss Price = Entry Price - (ATR × Multiplier)`
- **設定例**: ATR × 1.5, ATR × 2.0, ATR × 2.5
- **メリット**:
  - 市場のボラティリティに適応
  - 高ボラティリティ時は広め、低ボラティリティ時は狭めに自動調整
  - 業界標準的な手法
- **デメリット**:
  - ATR計算が必要（追加の計算コスト）
- **適用場面**: より洗練された損失確定が必要な場合

### 3. **トレーリングストップロス（Trailing Stop Loss）** ⭐⭐⭐ 最強推奨
- **方法**: 最高値からの一定パーセンテージまたは固定額で損失確定レベルを更新
- **動作**:
  - 利益が出たら、最高値からの一定パーセンテージ（例: -5%）で損失確定レベルを更新
  - 価格が下落しても、損失確定レベルは下方向にしか動かない
- **設定例**: 最高値から -5%, -7%, -10%
- **メリット**:
  - 利益を保護しつつ、さらに利益を伸ばすことが可能
  - 大きな利益を逃さない
  - 利益確定と損失確定を同時に実現
- **デメリット**:
  - 実装がやや複雑
  - ポジションの最高値を追跡する必要がある
- **適用場面**: 利益拡大を重視する場合

### 4. **移動平均ベース損失確定（MA-based Stop Loss）**
- **方法**: 移動平均線を下回ったら損失確定
- **設定例**: 長期移動平均、中期移動平均の下抜け
- **メリット**:
  - SimpleAgentと一貫性がある
  - トレンド転換を検出
- **デメリット**:
  - 移動平均の計算が必要
  - レイテンシーが発生する可能性
- **適用場面**: SimpleAgentと統合する場合

### 5. **時間ベース損失確定（Time-based Stop Loss）**
- **方法**: 一定期間利益が出ない場合に損失確定
- **設定例**: 24時間、48時間、1週間
- **メリット**:
  - 資金の効率的な利用
  - 長期の横ばい相場での損失を防ぐ
- **デメリット**:
  - 時間設定が難しい
- **適用場面**: 資金効率を重視する場合

## 🎯 推奨実装方針

### 段階1: 基本的な損失確定（初期実装）
**パーセンテージベース損失確定** を実装
- 実装が簡単
- 効果を検証しやすい
- デフォルト値: -7% (Bitcoinのボラティリティを考慮)

### 段階2: 高度な損失確定（改善版）
**トレーリングストップロス** を追加
- 利益を保護しつつ拡大
- より高い利益率を期待できる
- デフォルト値: 最高値から -5%

### 段階3: 統合版（最適化）
**ATRベース** または **移動平均ベース** を組み合わせ
- 複数の条件を組み合わせて最適化
- より洗練されたリスク管理

## 📈 期待される効果

### 単純な損失確定の効果
- **損失の制限**: 大きな損失を防ぐ
- **リスク管理の向上**: ダウンドローの削減
- **心理的負担の軽減**: 自動化による判断の排除

### トレーリングストップロスの効果
- **利益の保護**: 得た利益を失わない
- **利益の拡大**: 大きな利益を逃さない
- **利益率の向上**: 10-30%の利益率向上が期待できる

## 🔧 実装上の考慮事項

1. **エントリー価格の記録**: 損失確定を判定するために、エントリー価格を保持する必要がある
2. **ポジション管理**: 現在のポジション状態（BTC保有量、エントリー価格、最高値など）を追跡
3. **シグナルの優先順位**: 
   - 損失確定シグナル > 通常の売買シグナル
   - 損失確定が優先されるべき
4. **シミュレーション対応**: バックテストで損失確定をシミュレート可能にする

## 💡 推奨される組み合わせ

**最適な組み合わせ（推奨）**:
1. **基本**: パーセンテージベース損失確定（-7%）
2. **利益確定**: トレーリングストップロス（最高値から -5%）
3. **オプション**: ATRベース（ボラティリティが極端に高い場合）

この組み合わせにより、損失を制限しつつ、利益を最大化することが期待できます。

